// Generated by CoffeeScript 1.6.3
var filter, settings;

settings = {
  active: true
};

console.log('content');

chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
  console.log('content msg', request);
  if (request.type === "reFilter") {
    settings.filter = request.filter;
    filter();
  }
  return sendResponse({
    status: "ok"
  });
});

chrome.runtime.sendMessage({
  type: "getSettings"
}, function(set) {
  console.log("content settings", set);
  return settings = set;
});

filter = function() {
  var filterText;
  filterText = settings.filter;
  console.log('filtering by', filterText);
  $('[data-txt]').each(function(i, e) {
    return $(e).text($(e).attr('data-txt')).removeAttr('data-txt').removeClass('filter');
  });
  if (filterText.length === 0) {
    return;
  }
  return filterText.split(',').forEach(function(text) {
    var htmlElements;
    htmlElements = [];
    return 'p,a'.split(',').forEach(function(htmlElement) {
      htmlElements.push(htmlElement + ":contains('" + text + "')");
      return $(htmlElements.join(',')).each(function(i, e) {
        return $(e).attr('data-txt', $(e).text()).text('KABOOM').addClass('filter');
      });
    });
  });
};

$.expr[":"].contains = jQuery.expr.createPseudo(function(arg) {
  return function(elem) {
    return jQuery(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0;
  };
});

$(function() {
  var f, injectedScript, main;
  main = function() {
    var fireCustomEvent, myEvent;
    fireCustomEvent = function() {
      return document.body.dispatchEvent(myEvent);
    };
    myEvent = document.createEvent("Event");
    myEvent.initEvent("CustomEvent", true, true);
    if (typeof $ !== 'undefined' && typeof $(document).ajaxComplete !== 'undefined') {
      return $(document).ajaxComplete(function(event, request, settings) {
        fireCustomEvent();
      });
    } else {
      
  (function(){

    XMLHttpRequest.prototype.send = (function(orig){
        return function(){
            var xhr = this,
            waiter = setInterval(function(){
              console.log('trying2');
                if(xhr.readyState && xhr.readyState == 4){                  
                    fireCustomEvent();
                    clearInterval(waiter);
                }
            }, 250);
            return orig.apply(this, arguments);
        };
    })(XMLHttpRequest.prototype.send);

  })();
      ;
    }
  };
  injectedScript = document.createElement("script");
  injectedScript.type = "text/javascript";
  injectedScript.text = "(" + main + ")(\"\");";
  (document.body || document.head).appendChild(injectedScript);
  f = null;
  document.body.addEventListener("CustomEvent", function() {
    if (f) {
      clearTimeout(f);
    }
    f = setTimeout(filter, 500);
  });
  return filter();
});
